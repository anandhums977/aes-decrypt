<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AES Decryption Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input, textarea, select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: 'Courier New', monospace;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .decrypt-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .decrypt-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .clear-btn {
            background: #f5f5f5;
            color: #666;
        }

        .clear-btn:hover {
            background: #e0e0e0;
        }

        .result-section {
            margin-top: 30px;
            padding: 20px;
            border-radius: 10px;
            display: none;
        }

        .result-section.success {
            background: #d4edda;
            border: 2px solid #28a745;
            display: block;
        }

        .result-section.error {
            background: #f8d7da;
            border: 2px solid #dc3545;
            display: block;
        }

        .result-title {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .result-section.success .result-title {
            color: #155724;
        }

        .result-section.error .result-title {
            color: #721c24;
        }

        .result-text {
            background: white;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            word-wrap: break-word;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .info-box h3 {
            color: #1976D2;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-box ul {
            margin-left: 20px;
            color: #555;
            font-size: 13px;
        }

        .info-box li {
            margin-bottom: 5px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .radio-label input {
            margin-right: 8px;
            cursor: pointer;
        }

        .copy-btn {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .copy-btn:hover {
            background: #218838;
        }

        .view-json-btn {
            background: #007bff;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            margin-left: 10px;
            transition: background 0.3s;
        }

        .view-json-btn:hover {
            background: #0056b3;
        }

        .json-viewer {
            background: white;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.6;
        }

        .json-key {
            color: #881391;
            font-weight: 600;
        }

        .json-string {
            color: #1a1aa6;
        }

        .json-number {
            color: #1c00cf;
        }

        .json-boolean {
            color: #0d22aa;
            font-weight: 600;
        }

        .json-null {
            color: #808080;
            font-style: italic;
        }

        .json-toggle {
            cursor: pointer;
            user-select: none;
            display: inline-block;
            width: 16px;
            color: #666;
            font-weight: bold;
        }

        .json-toggle:hover {
            color: #007bff;
        }

        .json-collapsed {
            display: none;
        }

        .json-line {
            margin-left: 20px;
        }

        .json-bracket {
            color: #666;
            font-weight: bold;
        }

        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîì AES Decryption Tool</h1>
        <p class="subtitle">Decrypt your AES encrypted data using Node.js crypto logic</p>

        <div class="info-box">
            <h3>‚ÑπÔ∏è How to use:</h3>
            <ul>
                <li>Enter your encrypted data (Base64 format)</li>
                <li>Enter the secret key (will be padded/truncated to 16 bytes for AES-128)</li>
                <li>Enter the IV (will be padded/truncated to 16 bytes)</li>
                <li>Click "Decrypt" to see the result</li>
            </ul>
        </div>

        <form id="decryptForm">
            <div class="form-group full-width">
                <label for="encryptedData">Encrypted Data (Base64) *</label>
                <textarea 
                    id="encryptedData" 
                    placeholder="Paste your Base64 encrypted text here"
                    required
                ></textarea>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="secretKey">Secret Key *</label>
                    <input 
                        type="text" 
                        id="secretKey" 
                        placeholder="e.g., 1234567890123456"
                        required
                    />
                </div>

                <div class="form-group">
                    <label for="iv">IV (Initialization Vector) *</label>
                    <input 
                        type="text" 
                        id="iv" 
                        placeholder="e.g., dfghjuytrfgtyhuj"
                        required
                    />
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Key Size</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="keySize" value="128" checked />
                            128 bits (16 bytes)
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="keySize" value="256" />
                            256 bits (32 bytes)
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Encryption Mode</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="mode" value="CBC" checked />
                            CBC
                        </label>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button type="submit" class="decrypt-btn">üîì Decrypt</button>
                <button type="button" class="clear-btn" onclick="clearForm()">üóëÔ∏è Clear</button>
            </div>
        </form>

        <div id="result" class="result-section">
            <div class="result-title" id="resultTitle">Decryption Result:</div>
            <div class="result-text" id="resultText"></div>
            <div class="button-row">
                <button class="copy-btn" onclick="copyResult(event)">üìã Copy Result</button>
                <button class="view-json-btn" id="viewJsonBtn" onclick="toggleJsonView()" style="display: none;">üîç View JSON</button>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('decryptForm').addEventListener('submit', function(e) {
            e.preventDefault();
            decryptData();
        });

        // Mimic Node.js crypto.createDecipheriv logic using Web Crypto API
        async function tryDecrypt(encryptedData, secretKey, iv, keySize) {
            try {
                // Convert key to buffer and adjust length (same as Node.js logic)
                let keyBytes = new TextEncoder().encode(secretKey);
                const targetKeyLength = keySize === '128' ? 16 : 32;

                if (keyBytes.length < targetKeyLength) {
                    // Pad with zeros if too short
                    const padded = new Uint8Array(targetKeyLength);
                    padded.set(keyBytes);
                    keyBytes = padded;
                } else if (keyBytes.length > targetKeyLength) {
                    // Truncate if too long
                    keyBytes = keyBytes.slice(0, targetKeyLength);
                }

                // Convert IV to buffer and adjust length (always 16 bytes)
                let ivBytes = new TextEncoder().encode(iv);
                if (ivBytes.length < 16) {
                    const padded = new Uint8Array(16);
                    padded.set(ivBytes);
                    ivBytes = padded;
                } else if (ivBytes.length > 16) {
                    ivBytes = ivBytes.slice(0, 16);
                }

                console.log('Key length:', keyBytes.length, 'bytes');
                console.log('IV length:', ivBytes.length, 'bytes');

                // Decode base64 encrypted data
                const encryptedBytes = base64ToArrayBuffer(encryptedData);

                // Import key for Web Crypto API
                const cryptoKey = await crypto.subtle.importKey(
                    'raw',
                    keyBytes,
                    { name: 'AES-CBC' },
                    false,
                    ['decrypt']
                );

                // Decrypt
                const decryptedBuffer = await crypto.subtle.decrypt(
                    {
                        name: 'AES-CBC',
                        iv: ivBytes
                    },
                    cryptoKey,
                    encryptedBytes
                );

                // Convert to string
                const decrypted = new TextDecoder().decode(decryptedBuffer);
                return decrypted;

            } catch (error) {
                console.error('Decryption error:', error);
                throw new Error(error.message || 'Decryption failed');
            }
        }

        async function decryptData() {
            const encryptedData = document.getElementById('encryptedData').value.trim();
            const secretKey = document.getElementById('secretKey').value.trim();
            const iv = document.getElementById('iv').value.trim();
            const keySize = document.querySelector('input[name="keySize"]:checked').value;

            const resultDiv = document.getElementById('result');
            const resultTitle = document.getElementById('resultTitle');
            const resultText = document.getElementById('resultText');

            // Validation
            if (!encryptedData || !secretKey || !iv) {
                showError('Please fill in all required fields!');
                return;
            }

            try {
                const decrypted = await tryDecrypt(encryptedData, secretKey, iv, keySize);

                if (!decrypted || decrypted.length === 0) {
                    showError('Decryption failed! Check your key and IV.\n\nPossible reasons:\n1. Wrong secret key or IV\n2. Wrong key size selected\n3. Data is corrupted');
                    return;
                }

                // Show success
                resultDiv.className = 'result-section success';
                resultTitle.textContent = '‚úÖ Decryption Successful!';
                resultText.textContent = decrypted;

                // Check if result is valid JSON
                checkAndEnableJsonView(decrypted);

            } catch (error) {
                console.error('Decryption error:', error);
                showError(`Decryption failed: ${error.message}\n\nPlease verify:\n1. Encrypted data is valid Base64\n2. Secret key matches encryption key\n3. IV matches encryption IV\n4. Key size is correct`);
            }
        }

        function base64ToArrayBuffer(base64) {
            // Remove whitespace
            base64 = base64.replace(/\s/g, '');
            const binaryString = atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function showError(message) {
            const resultDiv = document.getElementById('result');
            const resultTitle = document.getElementById('resultTitle');
            const resultText = document.getElementById('resultText');

            resultDiv.className = 'result-section error';
            resultTitle.textContent = '‚ùå Decryption Failed';
            resultText.textContent = message;
        }

        function clearForm() {
            document.getElementById('decryptForm').reset();
            document.getElementById('result').className = 'result-section';
            document.getElementById('resultText').textContent = '';
            document.getElementById('viewJsonBtn').style.display = 'none';
            currentJsonData = null;
            isJsonViewActive = false;
        }

        function copyResult(event) {
            const btn = event.target;
            const originalText = btn.textContent;
            
            // Always copy the raw JSON data, not the rendered HTML
            let textToCopy;
            if (currentJsonData && isJsonViewActive) {
                // If JSON viewer is active, copy the raw JSON string
                textToCopy = JSON.stringify(currentJsonData, null, 2);
            } else {
                // Otherwise copy the text content
                textToCopy = document.getElementById('resultText').textContent;
            }
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                alert('Failed to copy: ' + err);
                console.error('Copy error:', err);
            });
        }

        let currentJsonData = null;
        let isJsonViewActive = false;

        function checkAndEnableJsonView(text) {
            const viewJsonBtn = document.getElementById('viewJsonBtn');
            try {
                currentJsonData = JSON.parse(text);
                viewJsonBtn.style.display = 'inline-block';
                isJsonViewActive = false;
                viewJsonBtn.textContent = 'üîç View JSON';
            } catch (e) {
                viewJsonBtn.style.display = 'none';
                currentJsonData = null;
            }
        }

        function toggleJsonView() {
            const resultText = document.getElementById('resultText');
            const viewJsonBtn = document.getElementById('viewJsonBtn');

            if (!currentJsonData) return;

            isJsonViewActive = !isJsonViewActive;

            if (isJsonViewActive) {
                resultText.innerHTML = '';
                resultText.classList.add('json-viewer');
                renderJson(currentJsonData, resultText);
                viewJsonBtn.textContent = 'üìÑ View Raw';
            } else {
                resultText.classList.remove('json-viewer');
                resultText.textContent = JSON.stringify(currentJsonData, null, 2);
                viewJsonBtn.textContent = 'üîç View JSON';
            }
        }

        function renderJson(data, container, depth = 0) {
            const indent = '  '.repeat(depth);

            if (data === null) {
                const span = document.createElement('span');
                span.className = 'json-null';
                span.textContent = 'null';
                container.appendChild(span);
            } else if (typeof data === 'boolean') {
                const span = document.createElement('span');
                span.className = 'json-boolean';
                span.textContent = data;
                container.appendChild(span);
            } else if (typeof data === 'number') {
                const span = document.createElement('span');
                span.className = 'json-number';
                span.textContent = data;
                container.appendChild(span);
            } else if (typeof data === 'string') {
                const span = document.createElement('span');
                span.className = 'json-string';
                span.textContent = `"${data}"`;
                container.appendChild(span);
            } else if (Array.isArray(data)) {
                if (data.length === 0) {
                    const span = document.createElement('span');
                    span.className = 'json-bracket';
                    span.textContent = '[]';
                    container.appendChild(span);
                } else {
                    const toggleId = 'toggle-' + Math.random().toString(36).substr(2, 9);
                    
                    const toggle = document.createElement('span');
                    toggle.className = 'json-toggle';
                    toggle.textContent = '‚ñº';
                    toggle.onclick = function() { toggleNode(toggleId); };
                    container.appendChild(toggle);
                    
                    const openBracket = document.createElement('span');
                    openBracket.className = 'json-bracket';
                    openBracket.textContent = ' [';
                    container.appendChild(openBracket);
                    
                    const childContainer = document.createElement('div');
                    childContainer.id = toggleId;
                    childContainer.className = 'json-line';
                    
                    data.forEach((item, index) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.style.marginLeft = '20px';
                        renderJson(item, itemDiv, depth + 1);
                        if (index < data.length - 1) {
                            const comma = document.createTextNode(',');
                            itemDiv.appendChild(comma);
                        }
                        childContainer.appendChild(itemDiv);
                    });
                    
                    container.appendChild(childContainer);
                    
                    const collapsedPreview = document.createElement('span');
                    collapsedPreview.className = 'json-collapsed-preview';
                    collapsedPreview.textContent = '...';
                    collapsedPreview.style.display = 'none';
                    collapsedPreview.style.color = '#999';
                    container.appendChild(collapsedPreview);
                    
                    const closeBracket = document.createElement('span');
                    closeBracket.className = 'json-bracket';
                    closeBracket.textContent = ']';
                    container.appendChild(closeBracket);
                }
            } else if (typeof data === 'object') {
                const keys = Object.keys(data);
                if (keys.length === 0) {
                    const span = document.createElement('span');
                    span.className = 'json-bracket';
                    span.textContent = '{}';
                    container.appendChild(span);
                } else {
                    const toggleId = 'toggle-' + Math.random().toString(36).substr(2, 9);
                    
                    const toggle = document.createElement('span');
                    toggle.className = 'json-toggle';
                    toggle.textContent = '‚ñº';
                    toggle.onclick = function() { toggleNode(toggleId); };
                    container.appendChild(toggle);
                    
                    const openBrace = document.createElement('span');
                    openBrace.className = 'json-bracket';
                    openBrace.textContent = ' {';
                    container.appendChild(openBrace);
                    
                    const childContainer = document.createElement('div');
                    childContainer.id = toggleId;
                    childContainer.className = 'json-line';
                    
                    keys.forEach((key, index) => {
                        const keyDiv = document.createElement('div');
                        keyDiv.style.marginLeft = '20px';
                        
                        const keySpan = document.createElement('span');
                        keySpan.className = 'json-key';
                        keySpan.textContent = `"${key}"`;
                        keyDiv.appendChild(keySpan);
                        
                        const colon = document.createTextNode(': ');
                        keyDiv.appendChild(colon);
                        
                        renderJson(data[key], keyDiv, depth + 1);
                        
                        if (index < keys.length - 1) {
                            const comma = document.createTextNode(',');
                            keyDiv.appendChild(comma);
                        }
                        childContainer.appendChild(keyDiv);
                    });
                    
                    container.appendChild(childContainer);
                    
                    const collapsedPreview = document.createElement('span');
                    collapsedPreview.className = 'json-collapsed-preview';
                    collapsedPreview.textContent = '...';
                    collapsedPreview.style.display = 'none';
                    collapsedPreview.style.color = '#999';
                    container.appendChild(collapsedPreview);
                    
                    const closeBrace = document.createElement('span');
                    closeBrace.className = 'json-bracket';
                    closeBrace.textContent = '}';
                    container.appendChild(closeBrace);
                }
            }
        }

        function toggleNode(id) {
            const element = document.getElementById(id);
            if (!element) return;
            
            // Find the toggle button (previous sibling that's a toggle)
            let toggle = element.previousElementSibling;
            while (toggle && !toggle.classList.contains('json-toggle')) {
                toggle = toggle.previousElementSibling;
            }
            
            // Find the collapsed preview (next sibling after childContainer)
            let preview = element.nextElementSibling;
            while (preview && !preview.classList.contains('json-collapsed-preview')) {
                preview = preview.nextElementSibling;
            }
            
            if (element.classList.contains('json-collapsed')) {
                element.classList.remove('json-collapsed');
                if (toggle) toggle.textContent = '‚ñº';
                if (preview) preview.style.display = 'none';
            } else {
                element.classList.add('json-collapsed');
                if (toggle) toggle.textContent = '‚ñ∂';
                if (preview) preview.style.display = 'inline';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
